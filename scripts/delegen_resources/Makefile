# Variables:
# NC_USER_LIBRARY_NAME
# NC_USER_INCLUDE_PATHS
# NC_USER_DEFINITIONS
# NC_GUEST_CC
# NC_GUEST_RUNTIME_INCLUDE_PATH
# NC_GUEST_RUNTIME_LINK_PATH
# NC_GUEST_OUTPUT_PATH
# NC_HOST_CC
# NC_HOST_RUNTIME_INCLUDE_PATH
# NC_HOST_RUNTIME_LINK_PATH
# NC_HOST_OUTPUT_PATH

# Metadata
LIBNAME := @NC_USER_LIBRARY_NAME@

# Guest
GUEST_CC := @NC_GUEST_CC@
GUEST_INCLUDE_DIRS := @NC_USER_INCLUDE_PATHS@ \
	@NC_GUEST_RUNTIME_INCLUDE_PATH@
GUEST_LINK_DIRS := \
	@NC_GUEST_RUNTIME_LINK_PATH@
GUEST_DEFINITIONS := @NC_USER_DEFINITIONS@ \
	X64NC_LIBRARY_NAME=\"$(LIBNAME)\"
GUEST_CFLAGS := -O2 -fPIC \
	-fno-stack-protector -fno-exceptions -Wl,-rpath=@NC_GUEST_RUNTIME_LINK_PATH@ \
	$(foreach item,$(GUEST_INCLUDE_DIRS),-I$(item)) \
	$(foreach item,$(GUEST_LINK_DIRS),-L$(item)) \
	$(foreach item,$(GUEST_DEFINITIONS),-D$(item))
GUEST_OUTPUT_PATH := @NC_GUEST_OUTPUT_PATH@

# Host
HOST_CC := @NC_HOST_CC@
HOST_INCLUDE_DIRS := @NC_USER_INCLUDE_PATHS@ \
	@NC_HOST_RUNTIME_INCLUDE_PATH@
HOST_LINK_DIRS := \
	@NC_HOST_RUNTIME_LINK_PATH@
HOST_DEFINITIONS := @NC_USER_DEFINITIONS@ \
	X64NC_LIBRARY_NAME=\"$(LIBNAME)\"
HOST_CFLAGS := -O2 -fPIC -Wl,-rpath=@NC_GUEST_RUNTIME_LINK_PATH@ \
	-fno-stack-protector -fno-exceptions \
	$(foreach item,$(HOST_INCLUDE_DIRS),-I$(item)) \
	$(foreach item,$(HOST_LINK_DIRS),-L$(item)) \
	$(foreach item,$(HOST_LINK_DIRS),-L$(item)) \
	$(foreach item,$(HOST_DEFINITIONS),-D$(item))
HOST_OUTPUT_PATH := @NC_HOST_OUTPUT_PATH@

# Project
GUEST_TARGET := $(GUEST_OUTPUT_PATH)/lib$(LIBNAME).so
HOST_TARGET := $(HOST_OUTPUT_PATH)/lib$(LIBNAME)_host_bridge.so

all: $(GUEST_TARGET) $(HOST_TARGET)

$(GUEST_TARGET): x64nc_delegate_guest.c
	$(GUEST_CC) -o $@ $(GUEST_CFLAGS) $< -shared -Wl,-z,defs -lx64nc-guestrt -ldl

$(HOST_TARGET): x64nc_delegate_host.c
	$(HOST_CC) -o $@ $(HOST_CFLAGS) $< -shared -Wl,-z,defs -lx64nc-hostrt -ldl

clean:
	rm $(GUEST_TARGET) $(HOST_TARGET)